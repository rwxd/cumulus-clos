# Generated by Ansible

# Defaults

{% for loopback in interfaces.loopbacks %}
auto {{ loopback.name }}
iface {{ loopback.name }} inet loopback
{% if "description" in loopback %}
    alias {{ loopback.description }}
{% endif %}
{% for ip in loopback.ip_addresses %}
    address {{ ip }}
{% endfor %}

{% endfor %}

auto mgmt
iface mgmt
    vrf-table auto
    address 127.0.0.1/8
    address ::1/128

auto eth0
iface eth0 inet dhcp
    alias Management
    vrf mgmt
    post-up sysctl -w net.ipv6.conf.eth0.accept_ra=2

# Specific device
## Physical Ports
{% for swp in interfaces.physicals %}
auto {{ swp.name }}
iface {{ swp.name }}
{% if swp.description  %}
    alias {{ swp.description }}
{% endif %}
{% if not swp.enabled %}
    link-down yes
{% endif %}
{% if "tagged_vlans" in swp %}
    bridge-vids{% for vid in swp.tagged_vlans %} {{ vid }}{% endfor +%}
{% endif %}
{% if "untagged_vlan" in swp %}
    bridge-access {{ swp.untagged_vlan }}
{% endif %}
{% if "duplex" in swp %}
    link-duplex {{ duplex }}
{% else %}
    link-duplex full
{% endif %}

{% endfor %}

## VLANs
{% for vlan in interfaces.vlans %}
auto {{ vlan.name }}
iface {{ vlan.name }}
{% if "description" in vlan %}
    alias {{ vlan.description }}
{% endif %}
    vlan_id {{ vlan.vlan_id }}
{% if "ip_addresses" in vlan %}
{% for ip in vlan.ip_addresses %}
    address {{ ip }}
    vlan-raw-device bridge
{% endfor %}
{% endif %}
{% if "vrf" in vlan %}
    vrf {{ vlan.vrf }}
{% endif %}

{% endfor +%}

## Bridges
{% set bridge_vids = [] -%}
{% for swp in interfaces.physicals -%}
    {% if "tagged_vlans" in swp -%}
        {% for vid in swp.tagged_vlans and vid not in bridge_vids -%}
            {% set bridge_vids = bridge_vids.append(vid) -%}
        {% endfor -%}
    {% endif -%}
    {% if "untagged_vlan" in swp and swp.untagged_vlan not in bridge_vids -%}
        {% set bridge_vids = bridge_vids.append(swp.untagged_vlan) %}
    {% endif -%}
{% endfor -%}

{% set bridge_ports = [] -%}
{% for swp in interfaces.physicals -%}
    {% if "tagged_vlans" in swp or "untagged_vlan" in swp %}
        {% if swp.name not in bridge_ports -%}
            {% set bridge_ports = bridge_ports.append(swp.name) -%}
        {% endif -%}
    {% endif -%}
{% endfor -%}

{% for bridge in interfaces.bridges +%}
auto {{ bridge.name }}
iface {{ bridge.name }}
{% if bridge_ports|length > 0 %}
    bridge-ports{% for name in bridge_ports %} {{ name }}{% endfor +%}
{% endif %}
{% if bridge_vids|length > 0 %}
    bridge-vids{% for vid in bridge_vids %} {{ vid }}{% endfor +%}
{% endif %}
    bridge-vlan-aware yes
    bridge-pvid 1
{% endfor +%}

## VRFs
{% for vrf in interfaces.vrfs %}
auto {{ vrf.name }}
iface {{ vrf.name }}
    vrf-table auto

{% endfor %}